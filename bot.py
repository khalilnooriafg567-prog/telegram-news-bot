import os
import requests
import json
import schedule
import time
from datetime import datetime
import pytz
from telegram import Bot
from telegram.error import TelegramError
import logging

# ุชูุธูุงุช ูุงฺฏ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# ุชูฺฉู ุฑุจุงุช ุชูฺฏุฑุงู - ุงูุฌุง ุฑุง ุชุบุฑ ุฏูุฏ
TELEGRAM_TOKEN = "ุชูฺฉู_ุฑุจุงุช_ุดูุง_ุงูุฌุง"  # ุชุบุฑ ุฏูุฏ
CHANNEL_USERNAME = "@ฺฉุงูุงู_ุดูุง"  # ุชุบุฑ ุฏูุฏ

# ุชูุธู ุฒูุงู ุงูุบุงูุณุชุงู
kabul_tz = pytz.timezone('Asia/Kabul')

# ููุฏุงุฑุฏู ุงููู
bot = None

def get_currency_rates_afg():
    """ุฏุฑุงูุช ูุฑุฎ ุงุฑุฒ ุจุฑุง ุงูุบุงูุณุชุงู"""
    try:
        # ูุฑุฎโูุง ููููู ุจุฑุง ุงูุบุงูุณุชุงู (ูุงุฒ ุจู API ูุงูุน ุฏุงุฑุฏ)
        # ุงูุฌุง ููุงุฏุฑ ููููู ูุฑุงุฑ ุฏุงุฏูโุงู
        return {
            'ุฏูุงุฑ ุงูุฑฺฉุง': '80 ุงูุบุงู',
            'ูุฑู ุงุฑููพุง': '85 ุงูุบุงู',
            'ุฑููพู ูพุงฺฉุณุชุงู': '0.28 ุงูุบุงู',
            'ุฑุงู ุงุฑุงู': '0.0019 ุงูุบุงู',
            'ุฏุฑูู ุงูุงุฑุงุช': '22 ุงูุบุงู'
        }
    except Exception as e:
        logger.error(f"ุฎุทุง ุฏุฑ ุฏุฑุงูุช ูุฑุฎ ุงุฑุฒ: {e}")
        return {
            'ุฏูุงุฑ ุงูุฑฺฉุง': 'โ๏ธ ุฎุทุง',
            'ูุฑู ุงุฑููพุง': 'โ๏ธ ุฎุทุง',
            'ุฑููพู ูพุงฺฉุณุชุงู': 'โ๏ธ ุฎุทุง',
            'ุฑุงู ุงุฑุงู': 'โ๏ธ ุฎุทุง',
            'ุฏุฑูู ุงูุงุฑุงุช': 'โ๏ธ ุฎุทุง'
        }

def get_gold_price_afg():
    """ุฏุฑุงูุช ููุช ุทูุง ุฏุฑ ุงูุบุงูุณุชุงู"""
    try:
        # ููุชโูุง ููููู ุจุฑุง ุงูุบุงูุณุชุงู
        return {
            'ุทูุง ฒด ุนุงุฑ (ุฏุฑ ูุฑ ฺฏุฑู)': '3200 ุงูุบุงู',
            'ุทูุง ฒฒ ุนุงุฑ (ุฏุฑ ูุฑ ฺฏุฑู)': '2950 ุงูุบุงู',
            'ุทูุง ฒฑ ุนุงุฑ (ุฏุฑ ูุฑ ฺฏุฑู)': '2800 ุงูุบุงู',
            'ุณฺฉู ุทูุง': '16000 ุงูุบุงู'
        }
    except:
        return {
            'ุทูุง ฒด ุนุงุฑ': 'โ๏ธ ุฎุทุง',
            'ุทูุง ฒฒ ุนุงุฑ': 'โ๏ธ ุฎุทุง',
            'ุทูุง ฒฑ ุนุงุฑ': 'โ๏ธ ุฎุทุง',
            'ุณฺฉู ุทูุง': 'โ๏ธ ุฎุทุง'
        }

def get_commodity_prices_afg():
    """ููุช ุญุจูุจุงุช ู ููุงุฏ ุบุฐุง"""
    try:
        return {
            'ฺฏูุฏู (ฺฉุณู ตฐ ฺฉูู)': '2500 ุงูุบุงู',
            'ุขุฑุฏ (ฺฉุณู ตฐ ฺฉูู)': '2800 ุงูุบุงู',
            'ุจุฑูุฌ (ฺฉุณู ตฐ ฺฉูู)': '3500 ุงูุบุงู',
            'ุฑูุบู ูุจุงุช (ูุชุฑ)': '120 ุงูุบุงู',
            'ุดฺฉุฑ (ฺฉูู)': '70 ุงูุบุงู',
            'ฺุง (ฺฉูู)': '400 ุงูุบุงู'
        }
    except:
        return {
            'ฺฏูุฏู': 'โ๏ธ ุฎุทุง',
            'ุขุฑุฏ': 'โ๏ธ ุฎุทุง',
            'ุจุฑูุฌ': 'โ๏ธ ุฎุทุง',
            'ุฑูุบู': 'โ๏ธ ุฎุทุง',
            'ุดฺฉุฑ': 'โ๏ธ ุฎุทุง',
            'ฺุง': 'โ๏ธ ุฎุทุง'
        }

def get_news_afg():
    """ุฏุฑุงูุช ุงุฎุจุงุฑ ุงูุบุงูุณุชุงู ู ุฌูุงู"""
    # ุงูุฌุง ูุงุฒ ุจู API ุฎุจุฑ ุฏุงุฑุฏ. ูุนูุงู ููููู:
    news_items = [
        "๐ฐ ุฎุจุฑูุง ููู ุงูุบุงูุณุชุงู - ุจู ุฑูุฒุฑุณุงู ูุญุธูโุง",
        "๐ ุงุฎุจุงุฑ ุจูโุงูููู ูุคุซุฑ ุจุฑ ููุทูู",
        "๐ฐ ุชุญููุงุช ุจุงุฒุงุฑูุง ูุงู ุฌูุงู",
        "โ๏ธ ุชุตููุงุช ููู ุญฺฉููุช ุงูุบุงูุณุชุงู",
        "๐ค ุฑูุงุจุท ุจูโุงูููู ุงูุบุงูุณุชุงู"
    ]
    return news_items[:4]  # ด ุฎุจุฑ ุงูู

def create_message():
    """ุณุงุฎุช ูพุงู ุจุฑุง ุงุฑุณุงู ุจู ฺฉุงูุงู"""
    now = datetime.now(kabul_tz)
    date_str = now.strftime("%Y/%m/%d - %H:%M")
    hijri_date = "ฑดฐต/ฑฐ/ฒฐ"  # ูุงุฒ ุจู ฺฉุชุงุจุฎุงูู ุชุจุฏู ุชุงุฑุฎ ุฏุงุฑุฏ
    
    currencies = get_currency_rates_afg()
    gold = get_gold_price_afg()
    commodities = get_commodity_prices_afg()
    news = get_news_afg()
    
    message = f"๐ **ุจุงุฒุงุฑ ุงูุบุงูุณุชุงู - {date_str}**\n"
    message += f"๐ ุชุงุฑุฎ ูุฌุฑ: {hijri_date}\n\n"
    
    message += "๐ฐ **ูุฑุฎ ุงุฑุฒ (ุงูุบุงู):**\n"
    for name, value in currencies.items():
        message += f"โข {name}: {value}\n"
    
    message += "\n๐ **ููุช ุทูุง (ุงูุบุงู):**\n"
    for name, value in gold.items():
        message += f"โข {name}: {value}\n"
    
    message += "\n๐พ **ููุช ุญุจูุจุงุช:**\n"
    for name, value in commodities.items():
        message += f"โข {name}: {value}\n"
    
    message += "\n๐ฐ **ุงุฎุจุงุฑ ููู:**\n"
    for i, item in enumerate(news, 1):
        message += f"{i}. {item}\n"
    
    message += "\n๐ **ุจู ุฑูุฒุฑุณุงู ุฎูุฏฺฉุงุฑ**\n"
    message += "๐ ูุฑ ด ุณุงุนุช | ๐ ฺฉุงุจูุ ุงูุบุงูุณุชุงู"
    
    return message

def send_to_channel():
    """ุงุฑุณุงู ูพุงู ุจู ฺฉุงูุงู ุชูฺฏุฑุงู"""
    global bot
    try:
        if bot is None:
            bot = Bot(token=TELEGRAM_TOKEN)
        
        message = create_message()
        bot.send_message(chat_id=CHANNEL_USERNAME, text=message, parse_mode='Markdown')
        logger.info(f"ูพุงู ุงุฑุณุงู ุดุฏ ุฏุฑ {datetime.now(kabul_tz)}")
    except Exception as e:
        logger.error(f"ุฎุทุง ุฏุฑ ุงุฑุณุงู ูพุงู: {e}")

def job():
    """ฺฉุงุฑ ุฒูุงูโุจูุฏ ุดุฏู"""
    logger.info("ุดุฑูุน ฺฉุงุฑ ุฒูุงูโุจูุฏ ุดุฏู")
    send_to_channel()

def main():
    """ุชุงุจุน ุงุตู"""
    global bot
    
    # ุชูุธู ุชูฺฉู ุงุฒ ูุชุบุฑ ูุญุท (ุจุฑุง Render)
    token = os.environ.get('TELEGRAM_TOKEN', TELEGRAM_TOKEN)
    if token == "ุชูฺฉู_ุฑุจุงุช_ุดูุง_ุงูุฌุง":
        logger.error("ูุทูุงู ุชูฺฉู ุฑุจุงุช ุฑุง ุชูุธู ฺฉูุฏ!")
        return
    
    bot = Bot(token=token)
    
    logger.info("ุฑุจุงุช ุดุฑูุน ุจู ฺฉุงุฑ ฺฉุฑุฏ...")
    
    # ุฒูุงูโุจูุฏ ุงุฑุณุงู ูพุงูโูุง
    schedule.every(4).hours.do(job)  # ูุฑ ด ุณุงุนุช
    # ุง ุจุฑุง ุชุณุช: schedule.every(2).minutes.do(job)
    
    # ุงููู ุงุฌุฑุง
    job()
    
    # ุญููู ุงุตู
    while True:
        schedule.run_pending()
        time.sleep(60)  # ฺฺฉ ูุฑ ุฏููู

if __name__ == "__main__":
    main()
